## Java 虚拟机结构

如果只是要去正确地实现Java虚拟机，只需要正确地读取class文件中的每一条字节码指令，并且能正确地执行这些指令所蕴含的操作即可。

### Class文件格式

编译后被Java虚拟机所执行的代码使用了一种平台中立（不依赖于硬件及操作系统）的二进制格式表示，并且经常以文件的形式储存。class文件格式精确地定义了类与接口的表示形式

### 数据类型

Java虚拟机可以操作的数据类型分为两类，原始类型和应用类型。与之对应，也存在原始值和引用值两种类型的数值。

### 原始类型与值

JVM所支持的原始数据类型包括 数值类型，boolean类型和returnAddress类型。

数值类型又分为整数类型和浮点类型。整数类包括byte，short，int，long，char，浮点类型包括float，double。

boolean类型

returnAddress类型：表示一条字节码指令的操作码。在虚拟机支持的所有原始类型中，只有returnAdress类型是不能直接与Java语言的数据类型相对应的

#### 整数类型取值范围

byte:   -128~127 （-2^7 ~ 2^7-1）,包括-128和127

short: -32768 ~ 32767 (-2^15 ~ 2^15-1) , 闭区间

int: -2 147 483 648 ~ 2 147 483 647 ( -2^31 ~ 2^31-1 ) , 闭区间 

long : -9 223 372 036 854 775 808 ~ 9 223 372 036 854 775 807 (-2^63 ~ 2^63-1)

char: 0 ~ 65535

#### boolean类型

JVM没有提供任何对于boolean类型专用的字节码指令，在Java中涉及boolean类型值的运算，编译后都使用JVM中的int数据类型来代替

### 引用类型与值

JVM中有三种引用类型，类类型（class type），数组类型（array type）和接口类型（interfece type），这些引用类型的值分别由类实例，数组实例，和实现了某个接口的类实例或数组实例动态创建。还有一个特殊值null，当一个引用不指向任何对象的时候，他的值就用null来表示，一个为null的引用，在没有上下文的情况下不具备任何实际的类型，但是有具体上下文时它可以转型为任意的类型引用。引用类型的默认值就是null。

### 运行时数据区

1.pc寄存器，JVM可以支持多条线程同时执行，每一条线程都有自己的pc(program counter)寄存器。任意时刻，一条Java虚拟机线程只会执行一个方法的代码，这个正在被线程执行的方法称为该线程的当前方法。如果这个方法不是native的，那么pc寄存器就保存Java虚拟机正在执行的字节码指令地址，如果这个方法是native的，那pc寄存器的值就是undefined。

2.Java虚拟机栈，每一条Java虚拟机线程都有自己私有的Java虚拟机栈，这个栈与线程同时创建，用于存储栈帧（Frame），存储局部变量与一些过程结果的地方，还有在方法调用和返回中也扮演了很重要的角色。异常，如果线程请求分配的栈容量超过Java虚拟机栈允许的最大容量，Java虚拟机会抛出一个StackOverflowError的异常。如果Java虚拟机可以动态扩展，且扩展的动作以及尝试过，但是目前无法申请到足够的内存区完成扩展，或在创建新的线程时没有足够的内存区创建对应的虚拟机栈，那么java虚拟机会抛出一个OutOfMemoryError的异常。

3.Java堆，堆是可供各个线程共享运行时内存区域，也是供所有类实例和数组对象分配内存的区域，存储被自动内存管理系统，也就是常说的GC所管理的各种对象。Java堆所使用的内存不需要保证是连续的。

4.方法区，在Java虚拟机中，方法区是可供各个线程共享运行时内存区域，方法区与传统语言的编译代码存储区或者操作系统进程的正文段的作用非常类似。它存储了每一个类的结构信息，如运行时常量池，字段和方法数据，构造函数和普通方法的字节码内容，还包括一些在类，实例，接口初始化时用到的特殊方法。简单虚拟机这个区域可以不实现垃圾回收。

5.运行时常量池，是class文件中每一个类或接口的常量池表的运行时表示形式，包括了若干种不同的常量，从编译期可知的数值字面量到必须运行期解析后才能获得的方法或字段引用。每一个运行时常量池都在java虚拟机的方法区中分配，在加载类和接口到虚拟机后，就创建对应的运行时常量池。

6.本地方法栈，Java虚拟机可实现可能会使用到传统的栈（通常称为C stack）来支持native方法（指使用Java以外的其他语言编写的方法）的执行，这个栈就是本地方法栈。当java虚拟机使用其他语言来实现指令集解释器时，也会使用到本地方法栈。